<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RSVP</title>

  <link rel="stylesheet" href="../styles.css">
  <link href="https://fonts.googleapis.com/css?family=Ms+Madi" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Content" rel="stylesheet">

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Load your private config (NOT tracked by GitHub) -->
  <script src="../supabase_config.js"></script>
</head>
<body>
  <nav class="nav-container">
    <button id="menuToggle" aria-expanded="false" aria-controls="quickLinks">Menu ▾</button>
    <div id="quickLinks" class="quick-links" hidden>
      <a href="../index.html">Home</a>
      <a href="donations.html">Gifts/Donations</a>
      <a href="FAQ.html">FAQ</a>
    </div>
  </nav>

  <h1>RSVP to Our Wedding</h1>

  <img src="../image_folder/DSC_0199.JPG" id="rsvpImages" alt="Engagement Photo" style="width:400px;height:auto;">
  <p id="rsvp_intro">We are looking forward to seeing you all on our special day! Please RSVP below by April 14th, 2026.
  We hope to see you there!</p>

  <main>
    <button id="open_rsvp" onclick="openRSVPModal()">RSVP Now</button>

    <div id="rsvp_modal" style="display:none;">
      <div class="modal-content">
        <span onclick="closeRSVPModal()" style="cursor:pointer; float:right; font-size:1.5em;">&times;</span>

        <h2>RSVP to Our Wedding</h2>

        <form id="rsvpForm">
          <label>Name *:
            <input type="text" id="name" required>
          </label>

          <label>Plus One:
            <input type="text" id="plus_one">
          </label>

          <label>Email *:
            <input type="email" id="email" required>
          </label>

          <label>Dietary Restrictions:
            <input type="text" id="dietary">
          </label>

          <label>Will you attend?
            <select id="attendance" required>
              <option value="yes">Yes</option>
              <option value="no">No</option>
            </select>
          </label>

          <button type="submit">Submit RSVP</button>
        </form>

        <!-- unique status element for modal -->
        <div id="rsvp_status" style="margin-top:10px;"></div>
      </div>
    </div>
  </main>

  <footer>
    <p>&copy; 2026 Meranda and Nikko Wedding</p>
  </footer>

  <script>
  // Modal open/close functions
  function openRSVPModal() {
    const modal = document.getElementById("rsvp_modal");
    if (modal) modal.style.display = "block";
  }
  function closeRSVPModal() {
    const modal = document.getElementById("rsvp_modal");
    if (modal) modal.style.display = "none";
  }

  // Main script
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("rsvpForm");
    const statusDiv = document.getElementById("rsvp_status");

    if (!form || !statusDiv) return;

    // Validate that Supabase and config variables are available
    if (!window.supabase) {
      console.error('Supabase library not loaded.');
      statusDiv.textContent = "⚠️ RSVP service unavailable right now. Please try again later.";
      return;
    }
    if (typeof supabaseUrl === 'undefined' || typeof supabaseKey === 'undefined') {
      console.error('Supabase config (supabaseUrl / supabaseKey) is missing.');
      statusDiv.textContent = "⚠️ RSVP configuration problem. Please contact the site owner.";
      return;
    }
    if (typeof supabaseTable === 'undefined') {
      console.error('Supabase table name (supabaseTable) is missing.');
      statusDiv.textContent = "⚠️ RSVP configuration problem. Please contact the site owner.";
      return;
    }

    const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      statusDiv.textContent = "Submitting...";
      statusDiv.style.color = "";

      const entry = {
        name: document.getElementById("name").value.trim(),
        plus_one: document.getElementById("plus_one").value.trim(),
        email: document.getElementById("email").value.trim(),
        attendance: document.getElementById("attendance").value,
        dietary: document.getElementById("dietary").value.trim()
      };

      // Basic client-side validation
      if (!entry.name || !entry.email) {
        statusDiv.textContent = "Please provide your name and email.";
        statusDiv.style.color = "red";
        return;
      }

      try {
        const { data, error } = await supabaseClient
          .from(supabaseTable)
          .insert([entry]);

        if (error) {
          console.error('Supabase insert error:', error);
          // show a helpful message to the user
          statusDiv.textContent = "❌ There was an error submitting your RSVP: " + (error.message || error);
          statusDiv.style.color = "red";
          return;
        }

        // Success
        statusDiv.textContent = "✔ Thank you! Your RSVP has been received.";
        statusDiv.style.color = "green";
        form.reset();

        // Optional: close after a few seconds
        setTimeout(closeRSVPModal, 9000);
      } catch (err) {
        console.error('Unexpected error submitting RSVP:', err);
        statusDiv.textContent = "❌ An unexpected error occurred. Please check your connection and try again.";
        statusDiv.style.color = "red";
      }
    });
  });
  </script>

  <script src="../scripts.js"></script>
</body>
</html>
